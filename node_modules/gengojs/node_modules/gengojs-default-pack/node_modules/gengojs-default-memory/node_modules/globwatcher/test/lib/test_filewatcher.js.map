{"version":3,"sources":["../src/test_filewatcher.js"],"names":[],"mappings":"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","file":"test/src/test_filewatcher.js","sourcesContent":["let fs = require(\"fs\");\nlet mocha_sprinkles = require(\"mocha-sprinkles\");\nlet path = require(\"path\");\nlet Promise = require(\"bluebird\");\nlet shell = require(\"shelljs\");\nlet should = require(\"should\");\nlet touch = require(\"touch\");\nlet util = require(\"util\");\n\nrequire(\"source-map-support\").install();\n\nlet future = mocha_sprinkles.future;\nlet withTempFolder = mocha_sprinkles.withTempFolder;\n\nlet FileWatcher = require(\"../../lib/globwatcher/filewatcher\").FileWatcher;\n\nfunction makeFixtures(folder) {\n  let past = Date.now() - 1000;\n  [\n    `${folder}/one.x`,\n    `${folder}/sub/one.x`,\n    `${folder}/sub/two.x`,\n    `${folder}/nested/three.x`,\n    `${folder}/nested/weird.jpg`\n  ].map((file) => {\n    shell.mkdir(\"-p\", path.dirname(file));\n    touch.sync(file, { mtime: past });\n  });\n}\n\nfunction fixtures(f) {\n  return future(withTempFolder((folder) => {\n    makeFixtures(folder);\n    return f(folder);\n  }));\n}\n\nfunction withFileWatcher(f) {\n  return (...x) => {\n    let watcher = new FileWatcher();\n    return f(watcher, ...x).finally(() => watcher.close());\n  };\n}\n\n\ndescribe(\"FileWatcher\", () => {\n  it(\"creates a watch\", fixtures(withFileWatcher((watcher, folder) => {\n    (watcher.timer == null).should.eql(true);\n    let watch = watcher.watch(`${folder}/one.x`);\n    (watch != null).should.eql(true);\n    (watcher.timer != null).should.eql(true);\n    return Promise.resolve();\n  })));\n  \n  it(\"reuses the same watch for the same filename\", fixtures(withFileWatcher((watcher, folder) => {\n    let watch1 = watcher.watch(`${folder}/one.x`);\n    let watch2 = watcher.watch(`${folder}/one.x`);\n    watch1.should.equal(watch2);\n    return Promise.resolve();\n  })));\n \n  it(\"notices a change\", fixtures(withFileWatcher((watcher, folder) => {\n    let watch = watcher.watch(`${folder}/one.x`);\n    let count = 0;\n    watch.on(\"changed\", () => count += 1);\n    touch.sync(`${folder}/one.x`);\n    count.should.eql(0);\n    return watch.check().then(() => {\n      count.should.eql(1);\n    });\n  })));\n\n  it(\"notices several changes at once\", fixtures(withFileWatcher((watcher, folder) => {\n    let countOne = 0;\n    let countTwo = 0;\n    watcher.watch(`${folder}/sub/one.x`).on(\"changed\", () => countOne += 1);\n    watcher.watch(`${folder}/sub/two.x`).on(\"changed\", () => countTwo += 1);\n    touch.sync(`${folder}/sub/one.x`);\n    touch.sync(`${folder}/sub/two.x`);\n    countOne.should.eql(0);\n    countTwo.should.eql(0);\n    return watcher.check().then(() => {\n      countOne.should.eql(1);\n      countTwo.should.eql(1);\n    });\n  })));\n\n  it(\"notices changes on a timer\", fixtures(withFileWatcher((watcher, folder) => {\n    let countOne = 0;\n    let countTwo = 0;\n    watcher.watch(`${folder}/sub/one.x`).on(\"changed\", () => countOne += 1);\n    watcher.watch(`${folder}/sub/two.x`).on(\"changed\", () => countTwo += 1);\n    touch.sync(`${folder}/sub/one.x`);\n    touch.sync(`${folder}/sub/two.x`);\n    countOne.should.eql(0);\n    countTwo.should.eql(0);\n    return Promise.delay(watcher.period + 10).then(() => {\n      countOne.should.eql(1);\n      countTwo.should.eql(1);\n    });\n  })));\n\n  it(\"queues stacked check() calls\", fixtures(withFileWatcher((watcher, folder) => {\n    let count = 0;\n    watcher.watch(`${folder}/one.x`).on(\"changed\", () => count += 1);\n    touch.sync(`${folder}/one.x`, { mtime: Date.now() + 1000 });\n    let visited = [ false, false ];\n    let x1 = watcher.check().then(() => {\n      count.should.eql(1);\n      touch.sync(`${folder}/one.x`, { mtime: Date.now() + 2000 });\n      visited[1].should.eql(false);\n      visited[0] = true;\n    });\n    let x2 = watcher.check().then(() => {\n      visited[0].should.eql(true);\n      visited[1] = true;\n      count.should.eql(2);\n    });\n    visited[0].should.eql(false);\n    visited[1].should.eql(false);\n    return Promise.all([ x1, x2 ]);\n  })));\n\n  it(\"detects size changes\", future(withTempFolder(withFileWatcher((watcher, folder) => {\n    let now = Date.now() - 15000;\n    let write = (data) => {\n      fs.writeFileSync(`${folder}/shifty.x`, data);\n      touch.sync(`${folder}/shifty.x`, { mtime: now });\n    };\n    write(\"abcdefghij\");\n    let count = 0;\n    watcher.watch(`${folder}/shifty.x`).on(\"changed\", () => count += 1);\n    write(\"klmnopqrst\");\n    return watcher.check().then(() => {\n      count.should.eql(0);\n      write(\"abcdef\");\n      return watcher.check();\n    }).then(() => {\n      count.should.eql(1);\n    });\n  }))));\n\n  it(\"can unwatch\", future(withTempFolder(withFileWatcher((watcher, folder) => {\n    touch.sync(`${folder}/changes.x`, { mtime: Date.now() - 15000 });\n    let watch = watcher.watch(`${folder}/changes.x`);\n    let count = 0;\n    watch.on(\"changed\", () => count += 1);\n    touch.sync(`${folder}/changes.x`, { mtime: Date.now() - 11000 });\n    return watcher.check().then(() => {\n      count.should.eql(1);\n      watcher.unwatch(`${folder}/changes.x`);\n      touch.sync(`${folder}/changes.x`, { mtime: Date.now() - 6000 });\n      return watcher.check();\n    }).then(() => {\n      count.should.eql(1);\n    });\n  }))));\n});\n"]}